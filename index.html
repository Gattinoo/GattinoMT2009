<!doctype html>
<meta charset="utf-8">
<title>Powiadomienia sesji</title>
<style>
  body{font:14px system-ui;margin:16px}
  button{padding:8px 12px;margin-right:6px}
  #log{margin-top:8px;color:#666;white-space:pre-wrap}
</style>

<h3>Powiadomienia sesji</h3>
<button id="start">Start</button>
<button id="stop" disabled>Stop</button>
<button id="test">Test</button>
<div id="log">Kliknij Start i zaakceptuj powiadomienia.</div>

<audio id="beep" preload="auto">
  <source src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" type="audio/ogg">
</audio>

<script>
const API_URL = 'https://script.google.com/macros/s/AKfycbylIgysG9keESQTXBIMni3kH1eW2WUof8CRQE1lV6rNoXSUXaX3BYi1Z-s8Yq9ORdbXuw/exec'; // <- PODMIEŃ

let t = null;

async function ensurePerm(){
  if(!('Notification' in window)) { log('Brak wsparcia Web Notifications'); return false; }
  if(Notification.permission === 'granted') return true;
  const p = await Notification.requestPermission();
  return p === 'granted';
}

async function fetchRows(){
  const res = await fetch(`${API_URL}?api=rows`, { cache: 'no-store' });
  if(!res.ok) throw new Error('HTTP '+res.status);
  return res.json(); // [{row,user,endStr}]
}

function showNotifs(rows){
  rows.forEach(r => {
    new Notification('Sesja zakończona', {
      body: `${r.user} — ${r.endStr}`,
      tag: `sesja-${r.row}`, // brak dubli
      renotify: false
    });
  });
  try { const b = document.getElementById('beep'); b.currentTime=0; b.play(); } catch {}
}

async function ack(rows){
  // Ack po GET (bez preflightu): /exec?api=ack&rows=2,5,9
  const ids = rows.map(r=>r.row).join(',');
  if(!ids) return;
  try { await fetch(`${API_URL}?api=ack&rows=${encodeURIComponent(ids)}`, { cache:'no-store' }); } catch {}
}

async function poll(){
  try{
    const rows = await fetchRows();
    if(Array.isArray(rows) && rows.length){
      showNotifs(rows);
      ack(rows);
      log(`Wysłano ${rows.length} powiadomień o ${new Date().toLocaleTimeString()}`);
    }
  }catch(err){
    log('Błąd: '+ (err && err.message || err));
  }
}

const log = (s)=> document.getElementById('log').textContent = s;

document.getElementById('start').onclick = async ()=>{
  if(!(await ensurePerm())) return log('Brak zgody na powiadomienia. Zezwól w przeglądarce.');
  if(t) clearInterval(t);
  t = setInterval(poll, 5000);
  poll();
  log('Monitorowanie aktywne (co 5 s).');
  start.disabled = true; stop.disabled = false;
};
document.getElementById('stop').onclick = ()=>{
  if(t) clearInterval(t); t=null;
  log('Zatrzymano.');
  start.disabled = false; stop.disabled = true;
};
document.getElementById('test').onclick = async ()=>{
  if(await ensurePerm()){
    new Notification('Test', { body: new Date().toLocaleString() });
  }
};
</script>
