<!doctype html>
<meta charset="utf-8">
<title>Powiadomienia sesji</title>
<style>
  body{font:14px system-ui;margin:16px}
  button{padding:8px 12px;margin-right:6px}
  #log{margin-top:8px;color:#666;white-space:pre-wrap}
</style>

<h3>Powiadomienia sesji</h3>
<button id="start">Start</button>
<button id="stop" disabled>Stop</button>
<button id="test">Test</button>
<div id="log">Kliknij Start i zaakceptuj powiadomienia.</div>

<audio id="beep" preload="auto">
  <source src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" type="audio/ogg">
</audio>

<script>
const API_URL = 'https://script.google.com/macros/s/AKfycbylIgysG9keESQTXBIMni3kH1eW2WUof8CRQE1lV6rNoXSUXaX3BYi1Z-s8Yq9ORdbXuw/exec'; // <- PODMIEŃ
let timer=null;

function jsonp(url){
  return new Promise((resolve, reject) => {
    const cb = 'cb_' + Math.random().toString(36).slice(2);
    window[cb] = (data) => { resolve(data); delete window[cb]; s.remove(); };
    const s = document.createElement('script');
    s.src = url + (url.includes('?')?'&':'?') + 'callback=' + cb + '&_=' + Date.now();
    s.onerror = (e)=>{ delete window[cb]; s.remove(); reject(e); };
    document.head.appendChild(s);
  });
}

async function poll(){
  try{
    const rows = await jsonp(`${API_URL}?api=rows`);
    if (Array.isArray(rows) && rows.length){
      rows.forEach(r => {
        new Notification('Sesja zakończona', {
          body: `${r.user} — ${r.endStr}`,
          tag: `sesja-${r.row}`, renotify: false
        });
      });
      try { const b=document.getElementById('beep'); b.currentTime=0; b.play(); } catch {}
      const ids = rows.map(r=>r.row).join(',');
      await jsonp(`${API_URL}?api=ack&rows=${encodeURIComponent(ids)}`);
      log(`Wysłano ${rows.length} powiadomień o ${new Date().toLocaleTimeString()}`);
    }
  } catch(err){
    log('Błąd: ' + (err?.message || err));
  }
}

async function ensurePerm(){
  if(!('Notification' in window)) { log('Brak wsparcia powiadomień'); return false; }
  if(Notification.permission === 'granted') return true;
  return (await Notification.requestPermission()) === 'granted';
}

const log = (s)=> document.getElementById('log').textContent = s;

start.onclick = async ()=>{
  if(!(await ensurePerm())) return log('Zezwól na powiadomienia.');
  if (timer) clearInterval(timer);
  timer = setInterval(poll, 5000);
  poll();
  log('Monitorowanie aktywne (co 5 s).');
  start.disabled = true; stop.disabled = false;
};
stop.onclick = ()=>{
  if(timer) clearInterval(timer); timer=null;
  log('Zatrzymano.');
  start.disabled = false; stop.disabled = true;
};
test.onclick = async ()=>{
  if(await ensurePerm()) new Notification('Test', { body: new Date().toLocaleString() });
};
</script>
